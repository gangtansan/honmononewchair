<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>쿠다모노카 고교 - 의자뺏기</title>
    <style>
        body { background: #1a1a1a; color: #d63031; font-family: 'serif'; text-align: center; margin: 0; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* 1. 로그인 화면 */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        input[type="text"] { background: #000; border: 1px solid #d63031; color: #fff; padding: 10px; font-size: 18px; text-align: center; margin-bottom: 20px; }

        /* 2. 게임 화면 */
        .chair-container { display: flex; justify-content: center; gap: 30px; margin-top: 100px; }
        .chair { 
            width: 120px; height: 160px; background: #2d3436; border: 3px solid #636e72; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-size: 16px; color: #fff; transition: 0.2s; padding: 10px;
        }
        .chair.taken { background: #d63031; border-color: #ff7675; cursor: not-allowed; }

        /* [중요] 화면 흐리게 연출 */
        .game-finished { filter: blur(5px); pointer-events: none; transition: 1s; }
        #survival-badge { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; color: #ff7675; z-index: 200; font-weight: bold; text-shadow: 2px 2px 10px #000; pointer-events: none; }

        /* 3. 타이핑 오버레이 */
        #typing-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #timer { font-size: 70px; color: #ff7675; margin-bottom: 20px; font-family: monospace; }
        #target-text { font-size: 28px; color: #fff; margin-bottom: 30px; }
        #typing-input { background: transparent; border: none; border-bottom: 2px solid #d63031; color: #fff; font-size: 24px; text-align: center; width: 80%; outline: none; }

        .admin-controls { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; }
        button { padding: 10px 20px; cursor: pointer; background: #2d3436; color: #fff; border: 1px solid #d63031; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>쿠다모노카 고교</h1>
        <input type="text" id="user-name" placeholder="출석 번호 또는 이름" maxlength="10">
        <button onclick="startApp()">접속</button>
    </div>

    <div id="game-screen" class="hidden">
        <h2 id="user-display"></h2>
        
        <div id="chair-wrapper-container">
            <div id="status-msg">의자를 선택하여 사과를 먹으십시오.</div>
            <div class="chair-container" id="chair-wrapper"></div>
        </div>

        <div id="survival-badge" class="hidden">생존 확정</div>

        <div id="typing-overlay" class="hidden">
            <div id="timer">5.00</div>
            <div id="target-text">제시어</div>
            <input type="text" id="typing-input" autocomplete="off">
        </div>

        <div class="admin-controls">
            <button onclick="adminInit(4)">의자 4개 생성</button>
            <button onclick="adminInit(3)">의자 3개 생성</button>
            <button onclick="adminInit(2)">의자 2개 생성</button>
        </div>
    </div>

    <audio id="main-bgm" src="bgm/Axe_Down.mp3" loop></audio>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // 1. 본인의 Firebase 설정값을 여기에 붙여넣으세요!
  const firebaseConfig = {
    apiKey: "AIzaSyAIgLmntmWDJROXiEYY-hw0uCFBo0kFkIk",
    authDomain: "chairsteal-f092e.firebaseapp.com",
    databaseURL: "https://chairsteal-f092e-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chairsteal-f092e",
    storageBucket: "chairsteal-f092e.firebasestorage.app",
    messagingSenderId: "447369461482",
    appId: "1:447369461482:web:03d8b7b7f8652510d0a193",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const gameRef = ref(db, 'game_state');

  // --- 기존 변수들 ---
  const bgm = document.getElementById('main-bgm');
  const phrases = ["나는 껍질이 아니다", "까마귀님의 가호가 있기를", "붉은 과실이 익어간다", "씨앗까지 씹어 삼켜라", "검은 깃털이 목구멍을 찌른다", "우리 바구니엔 반짝이는 과일들", "썩은 부위는 도려내야 한다", "모두 담기에 바구니가 작다", "낙과는 거름이 된다", "도망쳐도 까마귀님의 시야 안", "버려지는 것은 네가 되기를", "혓바닥 끝에 닿는 철분 맛"];
  
  let myIdentity = "";
  let currentChairId = null;
  let timerInterval = null;
  let hasChair = false;

  // 2. 관리자용: 의자 초기화 (데이터베이스에 쓰기)
  window.adminInit = (count) => {
    const chairs = {};
    for(let i=1; i<=count; i++) {
        chairs['chair' + i] = { occupant: "" };
    }
    set(gameRef, {
        chairCount: count,
        chairs: chairs,
        resetToken: Date.now() // 리셋 신호를 모든 클라이언트에 알림
    });
  };

  // 3. 실시간 감시: 데이터가 변하면 모든 유저의 화면이 바뀜
  onValue(gameRef, (snapshot) => {
    const data = snapshot.val();
    if(!data) return;

    // 관리자가 의자를 새로 깔았을 때 (리셋)
    const wrapper = document.getElementById('chair-wrapper');
    wrapper.innerHTML = '';
    
    // 리셋 시 효과 초기화
    hasChair = false;
    const container = document.getElementById('chair-wrapper-container');
    const badge = document.getElementById('survival-badge');
    if(container) { container.style.filter = "none"; container.style.pointerEvents = "auto"; }
    if(badge) badge.classList.add('hidden');

    // 의자 목록 그리기
    Object.entries(data.chairs).forEach(([id, info]) => {
        const div = document.createElement('div');
        div.className = `chair ${info.occupant ? 'taken' : ''}`;
        div.innerText = info.occupant ? info.occupant : "빈 의자";
        div.onclick = () => openTyping(id, info.occupant);
        wrapper.appendChild(div);
    });
  });

  // 4. 의자 클릭 및 성공 로직 수정
  window.openTyping = (id, occupant) => {
    if (hasChair) { alert("이미 사과를 먹었습니다."); return; }
    if (occupant) return; // 이미 주인이 있는 경우 클릭 방지

    currentChairId = id;
    const overlay = document.getElementById('typing-overlay');
    const target = document.getElementById('target-text');
    document.getElementById('typing-input').value = '';
    target.innerText = phrases[Math.floor(Math.random() * phrases.length)];
    overlay.classList.remove('hidden');
    document.getElementById('typing-input').focus();
    startTimer();
  };

  function startTimer() {
    let timeLeft = 5.00;
    const timerDisp = document.getElementById('timer');
    const input = document.getElementById('typing-input');
    const targetText = document.getElementById('target-text').innerText;
    
    timerInterval = setInterval(() => {
        timeLeft -= 0.01;
        timerDisp.innerText = timeLeft.toFixed(2);
        if(timeLeft <= 0) { clearInterval(timerInterval); failTyping(); }
    }, 10);

    input.oninput = () => {
        if(input.value === targetText) {
            clearInterval(timerInterval);
            successTyping();
        }
    };
  }

  function successTyping() {
    // Firebase 데이터베이스 업데이트 (내 이름을 의자에 박기)
    update(ref(db, `game_state/chairs/${currentChairId}`), {
        occupant: myIdentity
    });

    hasChair = true;
    document.getElementById('typing-overlay').classList.add('hidden');
    alert("생존 성공.");

    const container = document.getElementById('chair-wrapper-container');
    const badge = document.getElementById('survival-badge');
    if(container) { container.style.filter = "blur(5px)"; container.style.pointerEvents = "none"; }
    if(badge) badge.classList.remove('hidden');
  }

  function failTyping() {
    alert("실패.");
    document.getElementById('typing-overlay').classList.add('hidden');
  }

  // 로그인 기능 연결
  window.startApp = () => {
    const name = document.getElementById('user-name').value.trim();
    if(!name) return;
    myIdentity = name;
    bgm.volume = 0.1;
    bgm.play();
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('user-display').innerText = "생존자: " + myIdentity;
  };
</script>

</body>
</html>




