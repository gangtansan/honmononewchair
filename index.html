<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>쿠다모노카 고교 - 의자뺏기</title>
    <style>
        body { background: #1a1a1a; color: #d63031; font-family: 'serif'; text-align: center; margin: 0; overflow: hidden; }
        .hidden { display: none !important; }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        input[type="text"] { background: #000; border: 1px solid #d63031; color: #fff; padding: 10px; font-size: 18px; text-align: center; margin-bottom: 20px; }
        .chair-container { display: flex; justify-content: center; gap: 30px; margin-top: 100px; }
        .chair { width: 120px; height: 160px; background: #2d3436; border: 3px solid #636e72; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #fff; transition: 0.2s; padding: 10px; }
        .chair.taken { background: #d63031; border-color: #ff7675; cursor: not-allowed; }
        .game-finished { filter: grayscale(0.8) brightness(0.4); pointer-events: none; transition: 1s; }
        #survival-badge { position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: #ff7675; z-index: 200; text-shadow: 0 0 15px #d63031; pointer-events: none; }
        #typing-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #timer { font-size: 70px; color: #ff7675; margin-bottom: 20px; font-family: monospace; }
        #target-text { font-size: 28px; color: #fff; margin-bottom: 30px; }
        #typing-input { background: transparent; border: none; border-bottom: 2px solid #d63031; color: #fff; font-size: 24px; text-align: center; width: 80%; outline: none; }
        #admin-panel { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 15px; border: 1px solid #d63031; border-radius: 10px; z-index: 300; }
        button { padding: 10px 20px; cursor: pointer; background: #2d3436; color: #fff; border: 1px solid #d63031; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>쿠다모노카 고교</h1>
        <input type="text" id="user-name" placeholder="출석 번호 또는 이름" maxlength="10">
        <button onclick="startApp()">접속</button>
    </div>

    <div id="game-screen" class="hidden">
        <h2 id="user-display"></h2>
        <div id="survival-badge" class="hidden">생존 확정</div>
        
        <div id="chair-wrapper-container">
            <div id="status-msg">의자를 선택하여 사과를 먹으십시오.</div>
            <div class="chair-container" id="chair-wrapper"></div>
        </div>

        <div id="admin-panel" class="hidden">
            <button onclick="adminInit(4)">4개</button>
            <button onclick="adminInit(3)">3개</button>
            <button onclick="adminInit(2)">2개</button>
            <button onclick="adminInit(1)">1개</button>
        </div>

        <div id="typing-overlay" class="hidden">
            <div id="timer">5.00</div>
            <div id="target-text">제시어</div>
            <input type="text" id="typing-input" autocomplete="off">
        </div>
    </div>

    <audio id="main-bgm" src="bgm/Axe_Down.mp3" loop></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // [여기에 본인 설정값을 꼭 넣으세요!]
  const firebaseConfig = {
    apiKey: "AIzaSyAIgLmntmWDJROXiEYY-hw0uCFBo0kFkIk",
    authDomain: "chairsteal-f092e.firebaseapp.com",
    databaseURL: "https://chairsteal-f092e-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "chairsteal-f092e",
    storageBucket: "chairsteal-f092e.firebasestorage.app",
    messagingSenderId: "447369461482",
    appId: "1:447369461482:web:03d8b7b7f8652510d0a193",
  };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameRef = ref(db, 'game_state');

        const bgm = document.getElementById('main-bgm');
        const phrases = ["나는 껍질이 아니다", "까마귀님의 가호가 있기를", "붉은 과실이 익어간다", "씨앗까지 씹어 삼켜라", "검은 깃털이 목구멍을 찌른다", "우리 바구니엔 반짝이는 과일들", "썩은 부위는 도려내야 한다", "모두 담기에 바구니가 작다", "낙과는 거름이 된다", "도망쳐도 까마귀님의 시야 안", "버려지는 것은 네가 되기를", "혓바닥 끝에 닿는 철분 맛"];
        
        let myIdentity = "";
        let currentChairId = null;
        let timerInterval = null;
        let hasChair = false;

        // 접속 함수 (window에 등록)
        window.startApp = () => {
            const name = document.getElementById('user-name').value.trim();
            if(!name) { alert("이름을 입력해줘."); return; }
            myIdentity = name;
            
            // 관리자 비번 체크
            if(myIdentity === "학생회54") {
                document.getElementById('admin-panel').classList.remove('hidden');
            }

            bgm.volume = 0.1;
            bgm.play().catch(() => console.log("음악 재생은 클릭 후에 가능합니다."));
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('user-display').innerText = "생존자: " + myIdentity;
        };

        // 관리자 초기화 (window에 등록)
        window.adminInit = (count) => {
            const chairs = {};
            for(let i=1; i<=count; i++) chairs['chair' + i] = { occupant: "" };
            set(gameRef, { chairCount: count, chairs: chairs, resetTime: Date.now() });
        };

        // 데이터 감시 및 화면 업데이트
        onValue(gameRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            const wrapper = document.getElementById('chair-wrapper');
            wrapper.innerHTML = '';
            
            // 리셋 시 효과 해제
            hasChair = false;
            const container = document.getElementById('chair-wrapper-container');
            const badge = document.getElementById('survival-badge');
            if(container) { container.style.filter = "none"; container.style.pointerEvents = "auto"; }
            if(badge) badge.classList.add('hidden');

            // 실시간 의자 그리기
            Object.entries(data.chairs).forEach(([id, info]) => {
                const div = document.createElement('div');
                div.className = `chair ${info.occupant ? 'taken' : ''}`;
                div.innerText = info.occupant ? info.occupant : "빈 의자";
                div.onclick = () => window.openTyping(id, info.occupant);
                wrapper.appendChild(div);
            });
        });

        // 타이핑 창 열기
        window.openTyping = (id, occupant) => {
            if (hasChair) { alert("이미 생존했습니다."); return; }
            if (occupant) return;

            currentChairId = id;
            const overlay = document.getElementById('typing-overlay');
            const target = document.getElementById('target-text');
            const input = document.getElementById('typing-input');
            
            target.innerText = phrases[Math.floor(Math.random() * phrases.length)];
            input.value = '';
            overlay.classList.remove('hidden');
            input.focus();
            startTimer();
        };

        function startTimer() {
            let timeLeft = 5.00;
            const timerDisp = document.getElementById('timer');
            const input = document.getElementById('typing-input');
            const targetText = document.getElementById('target-text').innerText;
            
            timerInterval = setInterval(() => {
                timeLeft -= 0.01;
                timerDisp.innerText = timeLeft.toFixed(2);
                if(timeLeft <= 0) { clearInterval(timerInterval); failTyping(); }
            }, 10);

            input.oninput = () => {
                if(input.value === targetText) { clearInterval(timerInterval); successTyping(); }
            };
        }

        function successTyping() {
            update(ref(db, `game_state/chairs/${currentChairId}`), { occupant: myIdentity });
            hasChair = true;
            document.getElementById('typing-overlay').classList.add('hidden');
            alert("의자를 차지했습니다.");
            
            const container = document.getElementById('chair-wrapper-container');
            if(container) { container.style.filter = "grayscale(0.8) brightness(0.4)"; container.style.pointerEvents = "none"; }
            document.getElementById('survival-badge').classList.remove('hidden');
        }

        function failTyping() {
            alert("실패.");
            document.getElementById('typing-overlay').classList.add('hidden');
        }
    </script>
</body>
</html>
